# 다중 파이프라인

하나의 로그스태시에서 여러 개의 파이프라인을 동작하는 방법에 대해서 소개한다.      
프로젝트를 진행하다보면, 로그 입수 겨올가 다양해진다.     
그러나 문제점은 각각의 서버마다 로그의 형태가 다르다는 점이다.  

파이프라인을 구성하려고 하는데, 서로 다른 파이프라인을 구성해야한다.     
기존에는 로그스태시를 여러개 실행했지만, 이 경우 문제가 있다.       
실행된 로그스태시는 개별적이고 독립적인 JVM 인스턴스이기에 모니터링 및 관리가 어려워진다.   
  
다른 방식으로 조건문을 이용하는 것이 좋다.     
이렇게 하면 하나의 파이프라인으로 처리할 수 있지만 필터 처리가 복잡해진다.  

## 다중 파이프라인 작성 

다중 파이프라인은 하나의 로그스태시에서 여러 개의 파이프라인을 독립적으로 실행할 수 있게 한다.     
이를 처리하기 위해 pipelines.yml 파일을 수정해보자 
  
**pipelines.yml**   
```yml
- pipeline.id: mypipe1
  path.config: "/경로/mypipe1.conf"
- pipeline.id: mypipe2
  path.config: "/경로/mypipe2.conf"  
```

설정에대한 설명은 아래 표를 확인하자

|설정|설명|
|----|---|
|pipeline.id|파이프라인의 고유한 아이디|
|path.config|파이프라인 설정 파일의 위치|
|pipeline.workers|필터와 출력을 병렬로 처리하기 위한 워커 수,<br>기본적으로 호스트의 CPU코어 수와 동일하게 설정된다.|
|pipeline.batch.size|입력시 하나의 워커당 최대 몇개까지의 이벤트를 동시에 처리할지를 결정한다.<br>배치 처리된 이벤트들은 엘라스틱서치 출력에서 하나의 벌크 요청으로 묶이기 때문에,<br>이 수치가 클수록 요청 수행 횟수가 줄어들어 인덱싱 성능 개선 효과가 있지만,<br>그만큼 단일 요청이 커지므로 1000, 2000과 같이 적당히 조절해가며 튜닝할 필요가 있다.|
|queue.type|파이프라인에서 사용할 큐의 종류를 정할 수 있다.<br>기본적으로 memory 타입이 사용되나, persisted 타입을 선택해 이벤트의 유실을 좀 더 최소화할 수도 있다.|   
  
각각의 파이프라인들은 그 고유한 영역에 맞추어 설정을 진행하면 된다.      
로그스태시를 사용할 때, 기본으로 사용하는 파일은 `pipeline.yml` 이다.     
그렇기에 이전 예제와 달리 `-f`를 사용하지 않고 그냥 로그스태시를 실행하면 된다.  

