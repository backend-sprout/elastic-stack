# 파일비트 
## 파일비트 아키텍처

서버나 시스템을 운영하다보면 수많은 로그들이 파일 형태로 발생한다.    
파일비트는 이런 로그 파일을 쉽게 수집하도록 도와주며      
궁극적으로 엘라스틱서치와 키바나를 이용해 로그를 추적하고 통계를 만들어 활용할 수 있게 해준다.   

파일비트는 Go 언어 기반으로 JVM과 같은 무거운 런타임 라이브러리가 따로 필요하지 않아서   
가볍기 때문에 수집할 시스템에 부담 없이 부설치될 수 있다.    
그리고 로그스태시처럼 간단한 필터 작업도 가능하다.   

## 파일비트 구성요소 

|구성요소|내용|
|------|--|
|입력(input)|설정 파일에서 하베스터에 대한 입력 소스를 정한다.<br>파일비트 하나 혹은 여러개의 입력을 가질 수 있다.|
|하베스터(harvester)|입력에 명시된 파일을 직접 수집하는 주체다.<br>파일은 하나의 하베스터를 가지며,<br>하베스터는 파일을 한 줄씩 읽고 내보내는 역할을 한다.<br>또한 파일을 열고 닫는 역할도 한다.<br>하베스터가 실행되는 동안에는 파일 디스크립터가 열려있다.|
|스퓰러(spooler)|하베스터가 수집한 이벤트를 엘라스틱서치나 로그스태시 같은 장소로 전달한다.|

## 파일비트 실행 

원하는 로그 파일을 수집하기 위해 설정 파일(filebeat.yml)을 수정해야 한다.    
참고로, 설정 파일의 파라미터는 레퍼런스를 참조하는 것이 좋다.  

```
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/logs/*.log
  
output.elasticsearch:
  hosts ["localhost:9200"]

# output.kafka:
#   hosts: ["카프카Host:포트번호"]
#   topic: '토픽이름'
  
#   partition.round_robin:
#     reachable_only: false
#   required_acks: 1
#   compression: gzip
#   max_message_bytes: 1000000
    
# setup.kibana:
#   host: "localhost:5601"  
```
  
**인풋(input) : 파일비트가 가져오는 입력**  
|인풋 타입|설명|
|-------|---|
|log|가장 기본이 되는 타입으로, 파일 시스템의 지정한 경로에서 로그 파일을 읽어드린다.| 
|container|도커 같은 컨테이너의 로그를 수집하기 위한 입력으로,  파일을 읽어 들인다는 점에서 log와 유사하다.|
|s3|log 타입과 유사하나, 아마존 웹 서비스의 S3 버킷에 위치한 파일을 읽어드린다.|
|kafka|다른 타입과는 다르게 파일을 읽어 들이는 대신 카프카의 토픽을 읽어 들인다.|

레퍼런스에서 모든 파일비트 인풋 타입 설정 방법을 설명하고 있으니 참고하자.  


**아웃풋 : 하베스터가 읽어들인 데이터를 전달하는 곳**  
|아웃풋 타입|설명|
|--------|---|
|elasticsearch|가장 많이 사용되는 타입수집한 이벤트를 엘라스틱서치로 직접 인덱싱한다.|
|logstash|다수의 비츠를 사용해 엘라스틱서치로 전송되는 인덱싱 리퀘스트의 양이 많거나,<br>비츠나 인제스트 노드 수준에서 처리하기 어려운 가공 작업이 필요할 때 별도의 로그스태시를 구축한 후 수집한 이벤트를 전송한다.<br>다수의 인덱싱 요청이 로그스태시에서 단일 벌크 리퀘스트로 묶여 인덱싱 효율의 개선을 기대할 수 있다.<br>이때 전송한 이벤트는 로그스태시의 beats 인풋을 이용해 입력받을 수 있다.|  
|kafka|파일비트서 1차적으로 수집한 이벤트를 카프카로 전송한다.<br>카프카는 좀 더 안정적인 수집 파이프라인을 구성할 때<br>신뢰할만한 중간 저장소/큐 이므로수집 중 장애 발생시 데이터 손실을 최소화하기 위한 방안으로 활용된다.<br>최종적으로 엘라스틱 서치의 인덱싱을 원할 경우<br>이후 다시 파일비트의 카프카 인풋을 이용하거나 로그스태시의 카프카 인풋을 이용해 입력할 수 있다.|  
|console|수집한 이벤트를 시스템 콘솔에 출력한다.<br>일반적으로 수집이 정상적으로 이뤄지는지 입력 설정 테스트하기 위한 목적으로 사용된다.|

레퍼런스에서 모든 파일비트 아웃풋 타입 설정 방법을 설명하고 있으니 참고하자.  
추가로, 키바나를 사용한다면 setup.kibana 를 지정하여 대시보드에서 파일비트 데이터를 확인할 수 있다.  

## 실행 명령어

**셋업**
```
파일비트가 있는 디렉토리 > filebeat.exe setup -e
```

파일비트를 실행 하기전에, 먼저 setup 을 실행한다.     
`-e`는 모니터에 오류나 로그를 보여주는 옵션이다.       
    
**실제 실행**
```
파일비트가 있는 디렉토리 > filebeat.exe -e
```
파일비트를 실행한다. 
실행이 완료되었다면, 키바나에 현재 클러스터의 인덱스들을 확인할 수 있는데 `filebeat-*`라는 인덱스가 생성된다.  


## 파일비트 설정 
  
config 폴더에 `filebeat.reference.yml` 이라는 파일이 있다.    
파일 비트의 모든 설정에 대한 설명과 기본값이 적혀있는 참조 파일이다.    
버전에 맞추어 추가/삭제된 옵션이 모두 포함되어 있으니 설정 파일을 수정할 때 참고하자.  
   
https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-reference-yml.html 
   
### 유용한 설정
```  
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/logs/*.log
  ignore_older: 24h
  include_lines: ['^ERR', '^WARN'] # ERR or WARN 시작 로그 수집
  exclude_lines: ['^DBG']          # DBG 시작 로그 수집 안함 
  include_files" ['\.gz$']         # gz 형식의 파일 수집 
```
ignore_older : 새로운 파일 탐색시 오래된 파일은 읽어 들이지 않고 무시하기 위한 설정(기본값은 0)

* h : 시간
* m : 분
* 숫자만 : 초
* include_lines : 특정 라인을 정규표현식을 이용해 필터링하고 매칭된 라인만 비츠에 수용한다.
* exclude_lines : 특정 라인을 정규표현식을 이용해 필터링하고 매칭된 라인은 비츠에서 수집하지 않는다.  
* exclude_files : 패턴에 일치하는 파일을 무시할 때 사용한다.

이외에 알아두면 좋은 지식들 

GO 프로그래밍 언어로 작성되어있어 빠르다.(경량)

오픈소스 라이선스를 따르며 ‘럽비트’ 라는 프레임워크를 제공한다.즉, 사용자들이 직접 필요한 비트를 구현할 수 있다.

### 멀티라인 로그 처리 
  
로그가 한줄로 나오면 좋지만, 여러 줄로 나올때도 있다.    
자바 프로그램에서 자주보이는 패턴으로, 여러 라인을 하나의 로그로 인식해야한다.    
파일비트는 이런 경우를 위해 멀티라인 옵션을 제공하고 있다.  

자바 오류는 스택 트레이스 정보를 담고 있기 때문에 실제로 하나의 오류를 멀티라인으로 표현한다.   

```
filebeat.inputs:
- type : log
  enabled: true
  paths:
    - C:/elasticsearch-7.10.1/logs/*.log
  multiline.pattern: '^[[:space:]]'
  multiline.negate: false
  multiline.match: after
output.elasticsearch:
  hosts: ["localhost:9200"]
setup.kibana:
  hosts: "localhost:5601"
```  
인풋타입이 log 인 경우 멀티라인을 처리할 수 있다.    
multiline 설정에는 pattern, negate, match 라는 세가지 하위 옵션이 있으며     
이 3가지 설정을 조합해 읽어 들인 줄이 `로그의 끝인지`, 아니면 `다음 줄을 계속해서 읽어 들일지` 결정할 수 있다.  

* multiline.pattern :     
  정규식을 이용해서 패턴 지정    
  패턴과 일치하는 라인이 등장하면 멀티라인으로 인식한다.   
* multiline.negate :   
  true일때 패턴일치 조건을 반전시킨다.  
* multiline.match :   
  멀티라인을 처리하는 방식으로 before 와 after를 지정할 수 있다.  

## 모듈
  
모듈은 많이 사용되고 잘 알려진 시스템 데이터를 수집하기 위한 일반적인 설정을 사전 정의해둔 것이다.    
모듈을 이용하면 복잡한 가공이 필요한 이벤트인 경우에도 최소한의 비츠 설정으로 손쉽게 로그들을 수집할 수 있다.   
    
**예시)**       
엔진엑스나 아파치 서버의 로그를 수집한다고 가정해본다.     
특별히 사용자 설정 변경이 없었다면 **설치 경로나 로그 발생 위치, 로그 형태는 동일할 것이다.**       
이처럼 잘 알려진 서비스들은 동일한 설정으로 수집할 수 있기 때문에 모듈이라는 형태로 사전 설정을 제공하고 있다.  

|모듈|설명|
|---|---|
|aws|AWS의 CloudWatch, CloudTrail 같은 서비스에서 발생하는 로그들을 수집할 수 있다.|
|cef|시스로그를 통해 CEF(Common Event Format)이벤트를 입력받을 수 있다.|
|cisco|시스코사의 ASA, Nexus 등 네트워크 장비에서 발생되는 이벤트를 수집한다.|
|elasticsearch|엘라스틱서치의 클러스터, GC, 감사로그등을 수집할 때 사용한다.|
|googlecloud|구글 클라우드 플랫폼의 VPC 플로우, 방화벽 로그 등을 수집할 수 있다.|
|logstash|로그스태시에서 발생한 로그들을 수집할 수 있다.|

파일비트 모듈이고, 파일비트가 지원하는 전체 모듈은 온라인 문서에서 확인할 수 있다.     

1. 비트를 다운로드한다.   
2. 비트 설정 파일 수정한다.  
3. 모듈을 활성화하고 모듈 설정 파일을 수정한다.   
4. 엘라스틱서치와 키바나 대시보드를 사용할 수 있게 설정한다.  
5. 비트를 시작한다.
6. 키바나 대시보드에서 데이터를 확인한다.  




